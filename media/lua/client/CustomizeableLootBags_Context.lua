--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]

CustomizeableLootBags = CustomizeableLootBags or {}


-----------------------            ---------------------------
function CustomizeableLootBags.invContext(player, context, items)
    local pl = getSpecificPlayer(player)
    local isElevated = isDebugEnabled() or (isClient() and isAdmin())
    local useAll = false
    local iconMode = SandboxVars.CustomizeableLootBags.SetIconMode or 3
	local recorderFtype = 'Base.LootBagRecorder'

    if iconMode == 2 then
        useAll = true
    end

    for _, check in ipairs(items) do
        local item = nil

        if type(check) == "table" then
            item = check.items[1]
        elseif instanceof(check, "InventoryItem") then
            item = check
        end

        if item then
            local dispName = item:getDisplayName()

            if CustomizeableLootBags.isLootBag(item) then
                local optTip = context:addOptionOnTop("Open Loot Bag: " .. tostring(dispName), worldobjects, function()
                    CustomizeableLootBags.openLootBag(item, true)
                    local msg = tostring(item) .. ": " .. tostring(dispName)
                    pl:addLineChatElement(msg)
                    print(msg)
                    pl:playSoundLocal("OpenBag")
                end)

                local tip = ISInventoryPaneContextMenu.addToolTip()
                local iconPath = "media/textures/Item_MysteryLootBag_Blue.png"
                tip.description = "What could be inside?"
                tip:setName("Open Loot Bag: ")
                optTip.iconTexture = getTexture(iconPath)
                tip:setTexture(iconPath)
                optTip.toolTip = tip

                if isElevated and (iconMode == 2 or iconMode == 1) then
                    local Main = context:addOptionOnTop("Set Icon: " .. tostring(dispName))
                    local contextIcon = "media/textures/Item_MysteryLootBag_Green.png"
                    if useAll then
                        contextIcon = "media/textures/Item_MysteryLootBag_Yellow.png"
                    end
                    Main.iconTexture = getTexture(contextIcon)
                    local opt = ISContextMenu:getNew(context)
                    context:addSubMenu(Main, opt)
                    local items = ScriptManager.instance:getAllItems()

                    for i = 0, items:size() - 1 do
                        local scr = items:get(i)
                        local fType = tostring(scr:getModuleName()) .. "." .. tostring(scr:getName())
                        local ref = InventoryItemFactory.CreateItem(fType)

                        if CustomizeableLootBags.isBag(ref) or useAll then
                            local ico = ref:getTexture():getName()
                            local optTip = opt:addOption(CustomizeableLootBags.trimStr(tostring(ico)), worldobjects, function()
                                item:setTexture(getTexture(ico))
                                getSoundManager():playUISound("UIActivateMainMenuItem")
                                context:hideAndChildren()
                            end)
                            optTip.iconTexture = getTexture(ico)
                        end
                    end
                end
            end

            if isElevated then
                local recorder = nil
                local bag = nil
				local isShouldDel = SandboxVars.CustomizeableLootBags.DeleteOriginalBag or false

                if item:getFullType() == recorderFtype then
                    recorder = item
                    bag = recorder:getContainer()
                elseif CustomizeableLootBags.isBag(item) then
                    bag = item
                    recorder = item:getContainer():FindAndReturn(recorderFtype)
                end

                if recorder then

					local dupRec = context:addOptionOnTop("Duplicate Recorder: ")
					dupRec.iconTexture = getTexture("media/ui/MysteryLootBag_Dup.png")
					local opt = ISContextMenu:getNew(context)
					context:addSubMenu(dupRec, opt)
					opt:addOption("[ x1 ]", worldobjects, function()
						CustomizeableLootBags.duplicateRecord(recorder, 1)
					end)
					opt:addOption("[ x2 ]", worldobjects, function()
						CustomizeableLootBags.duplicateRecord(recorder, 2)
					end)
					opt:addOption("[ x5 ]", worldobjects, function()
						CustomizeableLootBags.duplicateRecord(recorder, 5)
					end)
					opt:addOption("[ x10 ]", worldobjects, function()
						CustomizeableLootBags.duplicateRecord(recorder, 10)
					end)
					opt:addOption("[ x25 ]", worldobjects, function()
						CustomizeableLootBags.duplicateRecord(recorder, 25)
					end)

					if bag and CustomizeableLootBags.isBag(bag) then
						local submenu = context:addOptionOnTop("Set Loot Bag: " .. tostring(dispName))
						local subContext = ISContextMenu:getNew(context)
						context:addSubMenu(submenu, subContext)

						local optBag = subContext:addOption("From Bag", worldobjects, function()
							CustomizeableLootBags.setLootBag(bag, isShouldDel, recorder)
							local msg = tostring(item) .. ": " .. tostring(dispName)
							pl:addLineChatElement(msg)
							print(msg)
							getSoundManager():playUISound("UIActivateMainMenuItem")
						end)

						local optRecorder = subContext:addOption("From Recorder", worldobjects, function()
							CustomizeableLootBags.setLootRecord(bag, isShouldDel, recorder)
							local msg = tostring(item) .. ": " .. tostring(dispName)
							pl:addLineChatElement(msg)
							print(msg)
							getSoundManager():playUISound("UIActivateMainMenuItem")
						end)

						local tip = ISInventoryPaneContextMenu.addToolTip()
						tip:setName("Set Loot Bag: ")
						tip.description = tostring(CustomizeableLootBags.getStrList(item))
						local iconPath = "media/textures/Item_MysteryLootBag_Red.png"
						submenu.iconTexture = getTexture(iconPath)
						tip:setTexture(iconPath)
						submenu.toolTip = tip
					end
				end
            end
        end
    end
end

Events.OnFillInventoryObjectContextMenu.Remove(CustomizeableLootBags.invContext)
Events.OnFillInventoryObjectContextMenu.Add(CustomizeableLootBags.invContext)
